// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  output     = "./../generated/prisma"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// User model
enum UserRole {
  USER
  ORGANIZATION
  ADMIN // TODO: Add this if I have time to implement (admin dashoboard)
}

enum SubscriptionTier {
  BASIC
  PRO
}

enum SubscriptionType {
  NONE
  MONTHLY
  YEARLY
}

model User {
  id                 String    @id @default(cuid())
  firstName          String
  lastName           String
  email              String    @unique
  password           String
  image              String?
  role               UserRole?
  bio                String?
  workOrSchool       String?
  DOB                String?
  address            String?
  onboardingFinished Boolean   @default(false)

  // Reset password token
  resetToken           String? @unique
  resetTokenExpireDate BigInt?

  // Verification token
  verificationToken          String? @unique
  verificationTokenExpiresAt BigInt?

  // Stripe
  customerId       String?          @unique
  pricingId        String?
  subscriptionTier SubscriptionTier @default(BASIC)
  subscriptionType SubscriptionType @default(NONE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Providers (google, discord etc.) information
  accounts Accounts[]

  //  Relations
  help                         Help[]
  notifications                Notification[]
  conversationParticipants     ConversationParticipants[]
  directMessagesConversations  DirectMessages[]
  organizationFollowers        OrganizationFollowers[]
  organizationMembers          OrganizationMember[]
  organizationJoinRequestsSent OrganizationJoinRequest[]
  posts                        Post[]
  postComments                 PostComments[]
  postLikes                    PostLikes[]
  postCommentsReplies          PostCommentsReply[]
  postCommentsLikes            PostCommentsLikes[]
  postCommentsReplyLikes       PostCommentsReplyLikes[]

  ownedOrganizations            Organization[]                 @relation("OrganizationOwner")
  organizationGroupChatMessages OrganizationGroupChatMessage[]
  organizationTaskQuestions     OrganizationTaskQuestions[]
  organizationLeaveFeedbacks    OrganizationLeaveFeedback[]
}

model Accounts {
  id           String  @id @default(uuid())
  provider     String
  providerId   String
  accessToken  String?
  refreshToken String?
  userId       String
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
}

enum SenderType {
  USER
  AI
}

// Help models
model Help {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  senderType SenderType
  content    String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

// Notification models
model Notification {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Direct messages models (1-on-1 conversations, not groups)
model DirectMessagesConversations {
  id             String                     @id @default(cuid())
  lastMessage    String?
  participants   ConversationParticipants[]
  pairKey        String                     @unique
  directMessages DirectMessages[]
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt

  @@index([updatedAt, id])
}

// n:n explicit relation table between users included in conversation (only 2 for now)
model ConversationParticipants {
  id             String                      @id @default(cuid())
  conversation   DirectMessagesConversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([conversationId, userId])
  @@index([userId])
}

model DirectMessages {
  id             String                      @id @default(cuid())
  conversation   DirectMessagesConversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String

  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  content              String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  directMessagesImages DirectMessagesImages[]

  @@index([conversationId, createdAt])
}

// Multiple images that could be attached to a single direct message
model DirectMessagesImages {
  id           String         @id @default(cuid())
  conversation DirectMessages @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId    String
  imageUrl     String // URL of the image stored in s3
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Organization {
  id          String @id @default(cuid())
  avatarImage String
  name        String
  bio         String
  ownerId     String
  owner       User   @relation("OrganizationOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  organizationFollowers    OrganizationFollowers[]
  organizationInfo         OrganizationInfo?
  organizationMembers      OrganizationMember[]
  organizationJoinRequests OrganizationJoinRequest[]

  groupChat OrganizationGroupChat?

  posts                      Post[]
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  organizationLeaveFeedbacks OrganizationLeaveFeedback[]
}

enum OrganizationMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum OrganizationJoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model OrganizationMember {
  id                                    String                                 @id @default(cuid())
  organization                          Organization                           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId                        String
  user                                  User                                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                                String
  role                                  OrganizationMemberRole                 @default(MEMBER)
  createdAt                             DateTime                               @default(now())
  updatedAt                             DateTime                               @updatedAt
  taskCardInformations                  OrganizationTaskInfo[]                 @relation("TaskCardMembersAssigned")
  organizatonMembersAsiggnedToTaskCards OrganizatonMembersAsiggnedToTaskCard[]

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId, role])
}

model OrganizationJoinRequest {
  id             String                        @id @default(cuid())
  organization   Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  requester      User                          @relation(fields: [requesterId], references: [id], onDelete: Cascade)
  requesterId    String
  title          String
  content        String
  status         OrganizationJoinRequestStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, requesterId])
  @@index([organizationId, status, createdAt])
  @@index([requesterId, status, createdAt])
}

model OrganizationInfo {
  id               String            @id @default(cuid())
  coverImage       String
  bio              String
  type             String
  location         String?
  additionalLinks  AdditionalLinks[]
  externalFormLink String?
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId   String            @unique
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model OrganizationFollowers {
  id String @id @default(cuid())

  followerUser   User         @relation(fields: [followerUserId], references: [id], onDelete: Cascade)
  followerUserId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, followerUserId])
  @@index([followerUserId])
  @@index([organizationId])
}

model OrganizationLeaveFeedback {
  id             String       @id @default(cuid())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  author         User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId       String

  reason      String
  suggestions String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdditionalLinks {
  id                 String           @id @default(cuid())
  name               String
  url                String
  organizationInfo   OrganizationInfo @relation(fields: [organizationInfoId], references: [id], onDelete: Cascade)
  organizationInfoId String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}

// Post

model Post {
  id           String         @id @default(cuid())
  title        String
  content      String
  authorId     String
  postImages   PostImages[]
  postComments PostComments[]

  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  author         User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  postLikes      PostLikes[]
}

model PostImages {
  id        String   @id @default(cuid())
  imageUrl  String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PostLikes {
  id     String @id @default(cuid())
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([postId, userId])
}

model PostComments {
  id       String @id @default(cuid())
  content  String
  post     Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId   String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  postCommentsReplies PostCommentsReply[]
  postCommentsLikes   PostCommentsLikes[]
}

model PostCommentsLikes {
  id          String       @id @default(cuid())
  postComment PostComments @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId   String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([commentId, userId])
}

model PostCommentsReply {
  id          String       @id @default(cuid())
  content     String
  postComment PostComments @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId   String
  author      User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId    String

  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  postCommentsReplyLikes PostCommentsReplyLikes[]
}

model PostCommentsReplyLikes {
  id               String            @id @default(cuid())
  postCommentReply PostCommentsReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  replyId          String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([replyId, userId])
}

model OrganizationGroupChat {
  id             String                         @id @default(cuid())
  organization   Organization                   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String                         @unique
  messages       OrganizationGroupChatMessage[]
  createdAt      DateTime                       @default(now())
  updatedAt      DateTime                       @updatedAt
}

model OrganizationGroupChatMessage {
  id                                 String                              @id @default(cuid())
  organizationGroupChat              OrganizationGroupChat               @relation(fields: [groupChatId], references: [id], onDelete: Cascade)
  groupChatId                        String
  author                             User                                @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId                           String
  content                            String
  organizationGroupChatMessageImages OrganizationGroupChatMessageImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([groupChatId, createdAt])
}

model OrganizationGroupChatMessageImage {
  id        String                       @id @default(cuid())
  message   OrganizationGroupChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String
  imageUrl  String // URL of the image stored in s3
  createdAt DateTime                     @default(now())
  updatedAt DateTime                     @updatedAt
}

model OrganizationTasksBoards {
  id                String             @id @default(cuid())
  organizationId    String
  organizationTasks OrganizationTask[]
  title             String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

enum OrganizationTaskStatus {
  // Change to 
  /**
   * /**
   * /**
   * LOW_PRIORITY
   * MEDIUM_PRIORITY
   * HIGH_PRIORITY
   */
  FAILURE
  PENDING
  COMPLETED
}

model OrganizationTask {
  id                        String                      @id @default(cuid())
  organizationId            String
  organizationTaskInfos     OrganizationTaskInfo?
  organizationTaskQuestions OrganizationTaskQuestions[]
  title                     String
  dueDate                   String
  status                    OrganizationTaskStatus      @default(PENDING)
  organizationTasksBoard    OrganizationTasksBoards?    @relation(fields: [organizationTasksBoardId], references: [id])
  organizationTasksBoardId  String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
}

model OrganizationTaskInfo {
  id                 String               @id @default(cuid())
  description        String
  membersAssigned    OrganizationMember[] @relation("TaskCardMembersAssigned")
  organizationTask   OrganizationTask     @relation(fields: [organizationTaskId], references: [id], onDelete: Cascade)
  organizationTaskId String               @unique

  createdAt                             DateTime                               @default(now())
  updatedAt                             DateTime                               @updatedAt
  organizatonMembersAsiggnedToTaskCards OrganizatonMembersAsiggnedToTaskCard[]
}

model OrganizatonMembersAsiggnedToTaskCard {
  id                     String               @id @default(cuid())
  organizationMember     OrganizationMember   @relation(fields: [organizationMemberId], references: [id], onDelete: Cascade)
  organizationMemberId   String
  organizationTaskInfo   OrganizationTaskInfo @relation(fields: [organizationTaskInfoId], references: [id], onDelete: Cascade)
  organizationTaskInfoId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationMemberId, organizationTaskInfoId])
}

model OrganizationTaskQuestions {
  id String @id @default(cuid())

  question           String
  organizationTask   OrganizationTask? @relation(fields: [organizationTaskId], references: [id], onDelete: Cascade)
  organizationTaskId String?

  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
